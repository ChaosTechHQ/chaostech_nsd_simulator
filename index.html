<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChaosTech NSD v16 - Investor-Ready Simulation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; font-family: 'Courier New', monospace; overflow: hidden; background: #0a0e27; color: #00ff00; }
        
        /* DEMO MODE BANNER - Always Visible */
        #demoModeBanner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff0000;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            z-index: 10001;
            font-size: 13px;
            letter-spacing: 1px;
        }
        
        /* COMPLIANCE BANNER */
        #complianceBanner {
            position: fixed;
            top: 40px;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            border-bottom: 2px solid #ffff00;
            color: #ffff00;
            padding: 8px 12px;
            z-index: 10000;
            font-size: 10px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        body { padding-top: 74px; }
        
        .container { display: flex; width: 100%; height: calc(100vh - 74px); }
        .radar { flex: 2; background: #0a0e27; border-right: 2px solid #00ff00; position: relative; overflow: hidden; }
        .panels { flex: 1; background: #0a0e27; border-left: 2px solid #00ff00; overflow-y: auto; display: flex; flex-direction: column; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .panel {
            border: 2px solid #00ff00;
            margin: 8px;
            padding: 12px;
            background: #0a0e27;
            color: #00ff00;
            font-size: 11px;
            flex-shrink: 0;
        }
        
        .panel-title { font-weight: bold; color: #ffff00; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-size: 10px; }
        .metric { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #003300; font-size: 10px; }
        .metric-label { color: #00ff00; }
        .metric-value { color: #ffff00; font-weight: bold; }
        
        button {
            background: #0a0e27;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 6px 10px;
            margin: 4px;
            cursor: pointer;
            font-size: 9px;
            font-weight: bold;
            transition: all 0.2s;
            font-family: 'Courier New', monospace;
        }
        
        button:hover { background: #00ff00; color: #0a0e27; }
        button.active { background: #ffff00; color: #0a0e27; }
        
        select {
            background: #0a0e27;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 6px;
            margin: 4px 0;
            width: 100%;
            font-size: 9px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
        }
        
        select option { background: #0a0e27; color: #00ff00; }
        
        .swarm-cohesion-panel {
            position: absolute;
            top: 20px;
            right: 10px;
            width: 240px;
            background: rgba(0,0,0,0.9);
            border: 2px solid #ff00ff;
            padding: 12px;
            font-size: 10px;
            z-index: 100;
            border-radius: 6px;
        }
        
        .performance-panel {
            position: absolute;
            top: 200px;
            left: 10px;
            width: 280px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0,0,0,0.9);
            border: 2px solid #00ff00;
            padding: 10px;
            font-size: 9px;
            z-index: 100;
            border-radius: 6px;
        }
        
        .cohesion-bar {
            width: 100%;
            height: 12px;
            background: #333;
            border: 1px solid #ff00ff;
            margin: 6px 0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .cohesion-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.3s ease;
        }
        
        .heatmap-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; margin-top: 6px; }
        .heatmap-cell { width: 100%; height: 8px; border: 1px solid #00ff00; }
        
        .compliance-footer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 8px;
            color: #999;
            background: rgba(0,0,0,0.9);
            padding: 8px 12px;
            border-radius: 4px;
            max-width: 200px;
            border: 1px solid #444;
            z-index: 999;
        }
        
        .threat-high { color: #ff0000; }
        .threat-med { color: #ffaa00; }
        .threat-low { color: #00ff00; }
    </style>
</head>
<body>
    <!-- RED DEMO MODE BANNER -->
    <div id="demoModeBanner">
        üî¥ DEMO MODE - SIMULATION ONLY - NO RF TRANSMIT - ALL ACTIONS SIMULATED
    </div>
    
    <!-- COMPLIANCE BANNER -->
    <div id="complianceBanner">
        SIMULATION ONLY ‚Ä¢ NO RF TRANSMIT ‚Ä¢ CONCEPT DEMO UI | This page simulates detection and analysis workflows only. It does not perform jamming, protocol spoofing, or network intrusion.
    </div>
    
    <!-- COMPLIANCE FOOTER -->
    <div class="compliance-footer">
        <strong>‚ö†Ô∏è Demo Simulator:</strong> All actions simulated. Authorized use only.
    </div>

    <div class="container">
        <!-- RADAR DISPLAY -->
        <div class="radar" id="radarContainer">
            <canvas id="radarCanvas"></canvas>
            
            <!-- SWARM COHESION PANEL -->
            <div class="swarm-cohesion-panel">
                <div style="color:#ff00ff; font-weight:bold; margin-bottom:8px;">üéØ SWARM COHESION</div>
                <div class="cohesion-bar"><div class="cohesion-fill" id="cohesionFill"></div></div>
                <div id="cohesionVal" style="color:#ffff00; margin:6px 0; font-size:9px;">Cohesion: N/A</div>
                <div id="hopPrediction" style="color:#00ffff; margin-top:6px; font-size:9px;">Next Freq: Detecting...</div>
                <button id="emulationBtn" onclick="activateProtocolEmulation()" style="width:100%; margin-top:8px; background:#ff00ff; color:#000; border:1px solid #ff00ff;">üü£ PROTOCOL EMULATION (SIM)</button>
                <div id="emulationStatus" style="color:#00ff00; font-size:8px; margin-top:6px;"></div>
            </div>
            
            <!-- PERFORMANCE METRICS PANEL -->
            <div class="performance-panel">
                <div class="panel-title">üìä PERFORMANCE METRICS</div>
                <div class="metric"><span>Det. Speed</span><span id="detectionSpeed" class="metric-value">0 ms</span></div>
                <div class="metric"><span>Det. Range</span><span id="detectionRange" class="metric-value">0 m</span></div>
                <div class="metric"><span>Det. Acc</span><span id="detectionAccuracy" class="metric-value">0%</span></div>
                <div class="metric"><span>Track Range</span><span id="trackingRange" class="metric-value">0 m</span></div>
                <div class="metric"><span>Track Acc</span><span id="trackingAccuracy" class="metric-value">0%</span></div>
                <div class="metric"><span>Mit. Success</span><span id="mitigationSuccess" class="metric-value">0%</span></div>
                <div class="metric"><span>Coverage</span><span id="coverage" class="metric-value">0 m¬≤</span></div>
                <div class="metric"><span>Reliability</span><span id="reliability" class="metric-value">0%</span></div>
                <div class="metric"><span>Score</span><span id="score" class="metric-value">0</span></div>
            </div>
        </div>

        <!-- CONTROL PANELS -->
        <div class="panels">
            <!-- THREAT MATRIX -->
            <div class="panel">
                <div class="panel-title">üéØ THREAT MATRIX & FINGERPRINT</div>
                <div style="background: #1a1e37; border: 2px solid #ffff00; padding: 8px; margin: 4px 0;">
                    <div style="color: #ffff00; font-weight: bold; font-size: 9px;" id="swarmId">SWARM-2026-001-DIAMOND</div>
                    <div style="color: #00ff00; font-size: 8px;" id="rfSig">RF: 2.4G + 5.8G + 10.5G</div>
                </div>
                <div class="metric">
                    <span>Formation</span>
                    <span class="metric-value" id="formation">DIAMOND</span>
                </div>
                <div class="metric">
                    <span>Threat Level</span>
                    <span class="metric-value threat-high" id="threatLevel">CRITICAL</span>
                </div>
                <div class="metric"><span>Detected</span><span class="metric-value" id="detected">0</span></div>
                <div class="metric"><span>Threats</span><span class="metric-value threat-high" id="threats">0</span></div>
                <div class="metric"><span>Mitigated (Sim)</span><span class="metric-value threat-low" id="mitigated">0</span></div>
            </div>
            
            <!-- SPAWN CONTROLS -->
            <div class="panel">
                <div class="panel-title">üìç SPAWN CONTROLS</div>
                <button onclick="addDrone('Hostile')" style="width:48%; margin-right:2%;">+ Hostile</button>
                <button onclick="addDrone('Ally')" style="width:48%;">+ Ally</button>
                <button onclick="spawnSwarm()" style="width:48%; margin-right:2%;">üêù SWARM x5</button>
                <button onclick="resetSimulation()" style="width:48%;">RESET</button>
                <div style="margin-top:6px;">
                    <select id="weather" onchange="updateEnvironment()">
                        <option value="clear">Clear</option>
                        <option value="rain">Rain (-22%)</option>
                        <option value="storm">Storm (-28%)</option>
                        <option value="snow">Snow (-18%)</option>
                    </select>
                    <select id="terrain" onchange="updateEnvironment()">
                        <option value="open">Open Terrain</option>
                        <option value="urban">Urban (-8%)</option>
                        <option value="mountain">Mountain (-10%)</option>
                    </select>
                </div>
            </div>
            
            <!-- FORMATION -->
            <div class="panel">
                <div class="panel-title">üî∑ FORMATION</div>
                <button onclick="setFormation('SCATTER')" style="width:23%; margin-right:1%;">SCATTER</button>
                <button onclick="setFormation('LINE')" style="width:23%; margin-right:1%;">LINE</button>
                <button onclick="setFormation('WEDGE')" style="width:23%; margin-right:1%;">WEDGE</button>
                <button onclick="setFormation('DIAMOND')" style="width:23%;">DIAMOND</button>
            </div>
            
            <!-- PRIORITY -->
            <div class="panel">
                <div class="panel-title">‚ö†Ô∏è PRIORITY</div>
                <div id="priorityBars"></div>
            </div>
            
            <!-- HEATMAP -->
            <div class="panel">
                <div class="panel-title">üî• HEATMAP</div>
                <div class="heatmap-grid" id="heatmap"></div>
            </div>
            
            <!-- RF SIGNATURES -->
            <div class="panel">
                <div class="panel-title">üì° RF SIGNATURES</div>
                <div id="rfSignatures" style="font-size: 9px;"></div>
            </div>
            
            <!-- PROTECTED ASSETS -->
            <div class="panel">
                <div class="panel-title">üõ°Ô∏è PROTECTED ASSETS (SIM)</div>
                <button onclick="toggleAsset('airport')" style="width:48%; margin-right:2%; font-size:8px; padding:4px;">‚úàÔ∏è Airport</button>
                <button onclick="toggleAsset('stadium')" style="width:48%; font-size:8px; padding:4px;">üèüÔ∏è Stadium</button>
                <button onclick="toggleAsset('base')" style="width:48%; margin-right:2%; font-size:8px; padding:4px;">ü™ñ Base</button>
                <button onclick="toggleAsset('convoy')" style="width:48%; font-size:8px; padding:4px;">üöö Convoy</button>
            </div>
            
            <!-- ACTIONS -->
            <div class="panel">
                <div class="panel-title">üéÆ ACTIONS</div>
                <button onclick="globalMitigation()">WIDE-AREA MITIGATION (SIM)</button>
                <button onclick="selectiveMitigation()">TARGETED MITIGATION (SIM)</button>
                <button onclick="toggleDynamicMode()" id="dynamicBtn">DYNAMIC MODE (SIM)</button>
                <button onclick="exportAAR()" style="background:#ff6600; border-color:#ff6600;">EXPORT AAR</button>
            </div>
            
            <!-- PREDICT AI -->
            <div class="panel">
                <div class="panel-title">ü§ñ PREDICT AI</div>
                <div class="metric"><span>Approaching</span><span class="metric-value" id="approaching">0</span></div>
                <div class="metric"><span>Avg Speed</span><span class="metric-value" id="avgSpeed">0</span></div>
                <div class="metric"><span>ETA (s)</span><span class="metric-value" id="eta">N/A</span></div>
            </div>
            
            <!-- PRECISION -->
            <div class="panel">
                <div class="panel-title">üéØ PRECISION</div>
                <div class="metric"><span>Targeting Acc</span><span class="metric-value" id="precision">0%</span></div>
                <div class="metric"><span>Collision Avoid</span><span class="metric-value" id="collision">ACTIVE</span></div>
            </div>
            
            <!-- TRIANGULATION -->
            <div class="panel">
                <div class="panel-title">üìç TRIANGULATION ORIGIN</div>
                <div class="metric" style="border:none;"><span>Signal</span><span class="metric-value" id="signal">-85dBm</span></div>
                <div class="metric" style="border:none;"><span>Accuracy</span><span class="metric-value" id="accuracy">¬±15m</span></div>
                <div class="metric" style="border:none;"><span>Lat</span><span class="metric-value" id="lat">38.8951¬∞N</span></div>
                <div class="metric" style="border:none;"><span>Lon</span><span class="metric-value" id="lon">-77.0369¬∞W</span></div>
                <div style="margin-top:6px; padding-top:6px; border-top:1px solid #003300; font-size:8px; color:#ffff00;">üìç Washington, DC</div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const state = {
            drones: [],
            formation: 'DIAMOND',
            weather: 'clear',
            terrain: 'open',
            jamActive: false,
            selectiveActive: false,
            missionStart: Date.now(),
            missionLog: [],
            droneCounter: 0,
            dynamicMode: false,
            dynamicInterval: null,
            score: 0,
            accuracyDebuff: 0,
            protectedAssets: {}
        };

        const weatherMods = { clear: 0, rain: -22, storm: -28, snow: -18 };
        const terrainMods = { open: 0, urban: -8, mountain: -10 };

        // ==================== CANVAS ====================
        let canvas, ctx, radarContainer;

        function initCanvas() {
            radarContainer = document.getElementById('radarContainer');
            canvas = document.getElementById('radarCanvas');
            canvas.width = radarContainer.clientWidth;
            canvas.height = radarContainer.clientHeight;
            ctx = canvas.getContext('2d');
        }

        // ==================== DRONE CLASS ====================
        class Drone {
            constructor(type) {
                this.id = `DRONE-${++state.droneCounter}`;
                this.type = type;
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 2;
                this.threat = type === 'Hostile' ? Math.random() * 100 : 0;
                this.jammed = false;
                this.rfBand = ['2.4G', '5.8G', '10.5G'][Math.floor(Math.random() * 3)];
                this.hardened = Math.random() > 0.8;
                this.redirected = false;
                this.targetX = null;
                this.targetY = null;
            }

            update() {
                if (this.jammed) return;
                if (this.redirected && this.targetX !== null) {
                    const dx = this.targetX - this.x;
                    const dy = this.targetY - this.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist > 3) {
                        this.x += (dx / dist) * 2;
                        this.y += (dy / dist) * 2;
                    }
                } else {
                    this.x += this.vx;
                    this.y += this.vy;
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
                }
            }

            draw() {
                const color = this.jammed ? '#ffff00' : (this.type === 'Hostile' ? '#ff0000' : '#00ff00');
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 5, 0, Math.PI * 2);
                ctx.fill();
                if (this.hardened) {
                    ctx.strokeStyle = '#ff00ff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        }

        // ==================== MAIN LOOP ====================
        function animate() {
            ctx.fillStyle = '#0a0e27';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#003300';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 50) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 50) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }

            state.drones.forEach(drone => {
                drone.update();
                drone.draw();
            });

            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 20, canvas.height / 2);
            ctx.lineTo(canvas.width / 2 + 20, canvas.height / 2);
            ctx.moveTo(canvas.width / 2, canvas.height / 2 - 20);
            ctx.lineTo(canvas.width / 2, canvas.height / 2 + 20);
            ctx.stroke();

            updateUI();
            updateSwarmCohesion();
            requestAnimationFrame(animate);
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            const hostile = state.drones.filter(d => d.type === 'Hostile').length;
            const jammedCount = state.drones.filter(d => d.jammed).length;

            document.getElementById('detected').textContent = state.drones.length;
            document.getElementById('threats').textContent = hostile;
            document.getElementById('mitigated').textContent = jammedCount;
            document.getElementById('swarmId').textContent = `SWARM-2026-${String(state.droneCounter).padStart(3, '0')}-${state.formation}`;
            document.getElementById('formation').textContent = state.formation;
            document.getElementById('rfSig').textContent = `RF: 2.4G + 5.8G + 10.5G (${state.drones.filter(d => d.hardened).length} hardened)`;

            updatePriority();
            updateHeatmap();
            updateRF();
            updateAIPrediction();
            updatePrecision();
            updateTriangulation();
            updatePerformanceMetrics();
        }

        function calculateEffectiveness() {
            const weather = weatherMods[state.weather] || 0;
            const terrain = terrainMods[state.terrain] || 0;
            let base = 100;
            if (state.jamActive) base -= 20;
            base += weather + terrain;
            return Math.max(0, base);
        }

        function updatePriority() {
            const container = document.getElementById('priorityBars');
            container.innerHTML = '';
            state.drones.slice(0, 4).forEach(drone => {
                const threat = Math.floor(drone.threat);
                const color = threat > 70 ? '#ff0000' : threat > 40 ? '#ffaa00' : '#00ff00';
                const bar = document.createElement('div');
                bar.style.cssText = `margin: 2px 0; background: linear-gradient(90deg, ${color} ${threat}%, #1a1e37); height: 12px; border: 1px solid ${color};`;
                container.appendChild(bar);
            });
        }

        let heatmapData = [];
        function initHeatmap() {
            for (let i = 0; i < 16; i++) heatmapData.push(Math.floor(Math.random() * 100));
            renderHeatmap();
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';
            heatmapData.forEach(heat => {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                const color = heat > 70 ? '#ff0000' : heat > 40 ? '#ffaa00' : '#003300';
                cell.style.backgroundColor = color;
                cell.style.borderColor = color;
                container.appendChild(cell);
            });
        }

        function updateHeatmap() {
            if (Math.random() > 0.95) {
                for (let i = 0; i < heatmapData.length; i++) {
                    heatmapData[i] = Math.max(0, Math.min(100, heatmapData[i] - 2 + Math.random() * 4));
                }
                renderHeatmap();
            }
        }

        function updateRF() {
            const container = document.getElementById('rfSignatures');
            const bands = {};
            state.drones.forEach(d => {
                bands[d.rfBand] = (bands[d.rfBand] || 0) + 1;
            });
            container.innerHTML = Object.entries(bands).map(([band, count]) => `<div>üîπ ${band}: ${count} drones</div>`).join('');
        }

        function updateEnvironment() {
            state.weather = document.getElementById('weather').value;
            state.terrain = document.getElementById('terrain').value;
        }

        function addDrone(type) {
            const drone = new Drone(type);
            state.drones.push(drone);
        }

        function setFormation(form) {
            state.formation = form;
            state.drones.forEach(d => {
                d.vx = (Math.random() - 0.5) * 2;
                d.vy = (Math.random() - 0.5) * 2;
            });
        }

        function resetSimulation() {
            state.drones = [];
            state.jamActive = false;
            state.selectiveActive = false;
            state.droneCounter = 0;
            state.score = 0;
            document.getElementById('emulationBtn').textContent = 'üü£ PROTOCOL EMULATION (SIM)';
            document.getElementById('emulationStatus').textContent = '';
        }

        function spawnSwarm() {
            for (let i = 0; i < 5; i++) {
                const drone = new Drone('Hostile');
                state.drones.push(drone);
            }
        }

        function globalMitigation() {
            state.jamActive = true;
            state.drones.forEach(d => {
                if (d.type === 'Hostile' && (!d.hardened || Math.random() > 0.25)) {
                    d.jammed = true;
                }
            });
        }

        function selectiveMitigation() {
            state.selectiveActive = true;
            const hostile = state.drones.filter(d => d.type === 'Hostile' && !d.jammed);
            hostile.slice(0, 2).forEach(d => d.jammed = true);
        }

        function activateProtocolEmulation() {
            const hostiles = state.drones.filter(d => d.type === 'Hostile');
            if (hostiles.length === 0) return;
            hostiles.forEach(d => {
                d.targetX = canvas.width / 2 + (Math.random() - 0.5) * 100;
                d.targetY = canvas.height / 2 + (Math.random() - 0.5) * 100;
                d.redirected = true;
            });
            document.getElementById('emulationBtn').textContent = 'üü¢ EMULATION ACTIVE (SIM)';
            document.getElementById('emulationBtn').style.background = '#00ff00';
            document.getElementById('emulationStatus').textContent = `${hostiles.length} tracks redirected (sim)`;
        }

        function updateAIPrediction() {
            const hostiles = state.drones.filter(d => d.type === 'Hostile' && !d.jammed);
            document.getElementById('approaching').textContent = hostiles.length;
            if (hostiles.length === 0) {
                document.getElementById('avgSpeed').textContent = '0';
                document.getElementById('eta').textContent = 'N/A';
                return;
            }
            let totalSpeed = 0;
            let nearestEta = Infinity;
            const centerX = canvas.width / 2, centerY = canvas.height / 2;
            hostiles.forEach(d => {
                const speed = Math.sqrt(d.vx * d.vx + d.vy * d.vy);
                totalSpeed += speed;
                const dx = d.x - centerX, dy = d.y - centerY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const eta = speed > 0 ? (dist / speed) / 30 : Infinity;
                if (eta < nearestEta) nearestEta = eta;
            });
            document.getElementById('avgSpeed').textContent = (totalSpeed / hostiles.length).toFixed(2);
            document.getElementById('eta').textContent = nearestEta === Infinity ? '‚àû' : nearestEta.toFixed(1);
        }

        function updatePrecision() {
            const mitigated = state.drones.filter(d => d.jammed).length;
            const total = state.drones.length;
            const acc = total > 0 ? Math.floor((mitigated / total) * 100) : 0;
            document.getElementById('precision').textContent = acc + '%';
        }

        let triangCache = { signal: '-85dBm', accuracy: '¬±15m', lat: '38.8951', lon: '-77.0369', lastUpdate: 0 };
        function updateTriangulation() {
            const now = Date.now();
            if (now - triangCache.lastUpdate < 3000) {
                document.getElementById('signal').textContent = triangCache.signal;
                document.getElementById('accuracy').textContent = triangCache.accuracy;
                document.getElementById('lat').textContent = triangCache.lat + '¬∞N';
                document.getElementById('lon').textContent = triangCache.lon + '¬∞W';
                return;
            }
            triangCache.signal = ['-75dBm', '-80dBm', '-85dBm', '-90dBm'][Math.floor(Math.random() * 4)];
            triangCache.accuracy = ['¬±5m', '¬±8m', '¬±12m', '¬±15m'][Math.floor(Math.random() * 4)];
            triangCache.lat = (38.8951 + (Math.random() - 0.5) * 0.01).toFixed(4);
            triangCache.lon = (-77.0369 + (Math.random() - 0.5) * 0.01).toFixed(4);
            triangCache.lastUpdate = now;
            document.getElementById('signal').textContent = triangCache.signal;
            document.getElementById('accuracy').textContent = triangCache.accuracy;
            document.getElementById('lat').textContent = triangCache.lat + '¬∞N';
            document.getElementById('lon').textContent = triangCache.lon + '¬∞W';
        }

        function updateSwarmCohesion() {
            const hostiles = state.drones.filter(d => d.type === 'Hostile');
            if (hostiles.length < 2) {
                document.getElementById('cohesionVal').textContent = 'Cohesion: N/A';
                document.getElementById('cohesionFill').style.width = '0%';
                return;
            }
            let totalDist = 0;
            for (let i = 0; i < hostiles.length; i++) {
                for (let j = i + 1; j < hostiles.length; j++) {
                    const dx = hostiles[i].x - hostiles[j].x;
                    const dy = hostiles[i].y - hostiles[j].y;
                    totalDist += Math.sqrt(dx*dx + dy*dy);
                }
            }
            const avgDist = totalDist / (hostiles.length * (hostiles.length - 1) / 2);
            let cohesion = Math.max(0, 1 - avgDist / 400);
            if (state.jamActive || state.selectiveActive) cohesion *= 0.3;
            const cohesionPercent = Math.round(cohesion * 100);
            document.getElementById('cohesionFill').style.width = cohesionPercent + '%';
            const state_txt = cohesion > 0.6 ? 'TIGHT' : cohesion > 0.3 ? 'FORMING' : 'FRAGMENTED';
            document.getElementById('cohesionVal').textContent = `Cohesion: ${cohesionPercent}% (${state_txt})`;
            const freqs = ['2.4 GHz', '5.8 GHz', '10.5 GHz', '900 MHz'];
            const idx = Math.floor(freqs.length * (1 - cohesion));
            document.getElementById('hopPrediction').textContent = `Next: ${freqs[Math.min(idx, freqs.length - 1)]}`;
        }

        function updatePerformanceMetrics() {
            const hostiles = state.drones.filter(d => d.type === 'Hostile');
            const range = Math.round(Math.min(canvas.width, canvas.height) / 2);
            const mitigated = state.drones.filter(d => d.jammed).length;
            
            document.getElementById('detectionSpeed').textContent = (500 + Math.random() * 1500).toFixed(0) + ' ms';
            document.getElementById('detectionRange').textContent = range + ' m';
            document.getElementById('detectionAccuracy').textContent = (hostiles.length > 0 ? 95 + Math.floor(Math.random() * 4) : 100) + '%';
            document.getElementById('trackingRange').textContent = range + ' m';
            document.getElementById('trackingAccuracy').textContent = (hostiles.length > 0 ? 93 + Math.floor(Math.random() * 4) : 100) + '%';
            document.getElementById('mitigationSuccess').textContent = (hostiles.length > 0 ? Math.floor((mitigated / hostiles.length) * 100) : 0) + '%';
            document.getElementById('coverage').textContent = (canvas.width * canvas.height) + ' m¬≤';
            document.getElementById('reliability').textContent = (hostiles.length > 0 ? 95 + Math.floor(Math.random() * 4) : 100) + '%';
            document.getElementById('score').textContent = state.score;
        }

        function toggleAsset(asset) {
            state.protectedAssets[asset] = !state.protectedAssets[asset];
        }

        function toggleDynamicMode() {
            state.dynamicMode = !state.dynamicMode;
            const btn = document.getElementById('dynamicBtn');
            if (state.dynamicMode) {
                state.dynamicInterval = setInterval(() => {
                    const rand = Math.floor(Math.random() * 3);
                    if (rand === 0) addDrone('Hostile');
                    else if (rand === 1) spawnSwarm();
                    state.score -= 5;
                }, 7000);
                btn.textContent = 'DYNAMIC MODE ON';
            } else {
                clearInterval(state.dynamicInterval);
                btn.textContent = 'DYNAMIC MODE (SIM)';
            }
        }

        function exportAAR() {
            const report = {
                timestamp: new Date().toISOString(),
                totalDetected: state.drones.length,
                hostileThreats: state.drones.filter(d => d.type === 'Hostile').length,
                mitigated: state.drones.filter(d => d.jammed).length,
                formation: state.formation,
                weather: state.weather,
                terrain: state.terrain,
                protectedAssets: Object.entries(state.protectedAssets).filter(([k,v]) => v).map(([k]) => k),
                score: state.score
            };
            console.log('=== AFTER-ACTION REPORT (SIMULATED) ===');
            console.log(JSON.stringify(report, null, 2));
            alert('AAR logged to console. Open Developer Tools (F12) to view.');
        }

        window.addEventListener('load', () => {
            initCanvas();
            initHeatmap();
            animate();
        });

        window.addEventListener('resize', () => {
            initCanvas();
        });
    </script>
</body>
</html>
